# heap 0

- **CTF:** picoCTF 2025
- **Category:** binary exploitation
- **Difficulty:** Easy

## Description

Are overflows just a stack concern?
Download the binary here.
Download the source here.
Additional details will be available after launching your challenge instance.

## Author
Abrxs, pr1or1tyQ

## hint
1. What part of the heap do you have control over and how far is it from the safe_var?


## Write-up

### プログラムで行っていること
1. input_dataにpico，safe_varにbicoが格納される．それぞれ5バイト
  ```
#define INPUT_DATA_SIZE 5 // input_dataに割り当てるメモリ量
#define SAFE_VAR_SIZE 5   // safe_varに割り当てるメモリ量

char *safe_var;
char *input_data;

void init() {
    input_data = malloc(INPUT_DATA_SIZE); // 5バイト確保
    strncpy(input_data, "pico", INPUT_DATA_SIZE); // "pico"をコピー
    safe_var = malloc(SAFE_VAR_SIZE);   // 5バイト確保
    strncpy(safe_var, "bico", SAFE_VAR_SIZE);     // "bico"をコピー
}
  ```

2. safe_varが`bico`でなければflagを入手できる．
```
void check_win() {
    if (strcmp(safe_var, "bico") != 0) { // safe_varが"bico"と異なればflagを入手
        printf("\nYOU WIN\n");
        // Print flag
        char buf[FLAGSIZE_MAX];
        FILE *fd = fopen("flag.txt", "r");
        fgets(buf, FLAGSIZE_MAX, fd);
        printf("%s\n", buf);
        fflush(stdout);
        exit(0);
    } else {
        printf("Looks like everything is still secure!\n");
        printf("\nNo flage for you :(\n");
        fflush(stdout);
    }
}
```
3. ユーザーの入力を行う`scanf("%s", input_data);`は入力文字列の長さをチェックせず、バッファサイズ（この場合はINPUT_DATA_SIZEの5バイト）を超えても書き込みを行う．  
   ヒープバッファオーバーフローの例．
4. input_dataとsafe_varのアドレスは以下の通り
`input_data`: `0x58380c8202b0`  
`safe_var`: `0x58380c8202d0`
```
Heap State:
+-------------+----------------+
[*] Address    ->    Heap Data
+-------------+----------------+
[*]    0x58380c8202b0  ->    pico
+-------------+----------------+
[*]    0x58380c8202d0  ->    bico
+-------------+----------------+
```

### 解き方
1. scanfを使ってinput_dataの割り当てサイズを超える入力を行い，safe_varの領域を上書きする
2. 上書きするためには少なくとも5バイト＋32バイトの入力が必要
3. `AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA`を入力するとflagを入手できる．

### Flag
`FLAG : picoCTF{my_first_heap_overflow_76775c7c}`
